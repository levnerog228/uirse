<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5%;
            min-height: 100vh;
        }

        .content-container {
            background-color: #fff;
            width: 100%;
            max-width: 2200px;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }

        .header-nav {
            background-color: #676767;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-radius: 10px;
            width: 100%;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            height: 50px;
            max-width: 150px;
        }

        .nav-actions button {
            background-color: #FB9C9C;
            border: none;
            padding: 12px 12px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .page-title {
            text-align: center;
            margin: 20px 0;
            font-size: 2.5rem;
            color: #676767;
        }

        .profile-container {
            display: flex;
            width: 100%;
            gap: 30px;
            margin-top: 20px;
        }

        .profile-sidebar {
            width: 300px;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
        }

        .profile-content {
            flex: 1;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
        }

        .user-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #D9D9D9;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #676767;
        }

        .user-email {
            text-align: center;
            color: #676767;
            margin-bottom: 20px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 10px;
        }

        .nav-menu a {
            display: block;
            padding: 10px 15px;
            color: #676767;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background-color: #FB9C9C;
            color: white;
        }

        .section-title {
            font-size: 1.8rem;
            color: #676767;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FB9C9C;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-label {
            font-weight: bold;
            color: #676767;
            margin-bottom: 5px;
        }

        .info-value {
            padding: 10px;
            background: white;
            border-radius: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .edit-btn {
            background-color: #85CAFF;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            transition: background-color 0.3s;
        }

        .edit-btn:hover {
            background-color: #6bb8f5;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .image-card:hover {
            transform: translateY(-5px);
        }

        .image-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-info {
            padding: 10px;
        }

        .image-date {
            font-size: 0.8rem;
            color: #676767;
        }

        .image-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .image-actions button {
            background-color: #FB9C9C;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        /* Адаптация для мобильных устройств */
        @media (max-width: 991px) {
            .profile-container {
                flex-direction: column;
            }

            .profile-sidebar {
                width: 100%;
            }

            .user-info-grid {
                grid-template-columns: 1fr;
            }

            .header-nav {
                flex-direction: column;
                align-items: center;
                padding: 15px 20px;
            }

            .logo {
                height: 30px;
                margin-bottom: 10px;
            }

            .page-title {
                font-size: 1.8rem;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-wrapper">
        <div class="content-container">
            <nav class="header-nav">
                <img src="logo.png" alt="Site Logo" class="logo" />
                <div class="nav-actions">
                    <button onclick="window.location.href='/'">На главную</button>
                </div>
            </nav>

            <h1 class="page-title">Личный кабинет</h1>

            <div class="profile-container">
                <div class="profile-sidebar">
                    <div class="user-avatar">
                        <img src="{{ user.get('avatar_url', 'https://via.placeholder.com/150') }}" alt="Аватар пользователя">
                    </div>
                   <h2 class="user-name">
     {{ user.last_name }} {{ user.first_name }} {{ user.middle_name if user.middle_name }}
</h2>
                    <p class="user-email">{{ user.get('email', 'user@example.com') }}</p>

                    <ul class="nav-menu">
                        <li><a href="#" class="active">Личные данные</a></li>
                        <li><a href="#">Мои изображения</a></li>
                        <li><a href="#">История действий</a></li>
                        <li><a href="/logout">Выйти</a></li>
                    </ul>
                </div>

                <div class="profile-content">
                    <div class="personal-info-section">
                        <h3 class="section-title">Личные данные</h3>

                        <div class="user-info-grid">
                            <div class="info-item">
                                <div class="info-label">Имя</div>
                                <div class="info-value">{{ user.get('first_name', 'Иван') }}</div>
                                <button class="edit-btn">Изменить</button>
                            </div>

                            <div class="info-item">
                                <div class="info-label">Фамилия</div>
                                <div class="info-value">{{ user.get('last_name', 'Иванов') }}</div>
                                <button class="edit-btn">Изменить</button>
                            </div>

                            <div class="info-item">
                                <div class="info-label">Электронная почта</div>
                                <div class="info-value">{{ user.get('email', 'user@example.com') }}</div>
                                <button class="edit-btn">Изменить</button>
                            </div>

                            <div class="info-item">
                                <div class="info-label">Телефон</div>
                                <div class="info-value">{{ user.get('phone', '+7 (123) 456-78-90') }}</div>
                                <button class="edit-btn">Изменить</button>
                            </div>

                            <div class="info-item">
                                <div class="info-label">Дата рождения</div>
                                <div class="info-value">{{ user.get('birth_date', '01.01.1990') }}</div>
                                <button class="edit-btn">Изменить</button>
                            </div>

                            <div class="info-item">
                                <div class="info-label">Дата регистрации</div>
                                <div class="info-value">{{ user.get('registration_date', '15.05.2025') }}</div>
                            </div>
                        </div>
                    </div>

                   <div class="images-section">
                        <h3 class="section-title">Последние загруженные изображения</h3>

                        <div class="images-grid">
                            {% for image in images %}
                            <div class="image-card" data-image-id="{{ image.id }}">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                     alt="Обработанное изображение" class="image-thumbnail">
                                <div class="image-info">
                                    <div class="image-date">{{ image.upload_date.strftime('%d.%m.%Y') }}</div>
                                    <div class="image-actions">
                                        <button class="view-btn">Просмотр</button>
                                        <button class="delete-btn">Удалить</button>
                                        <button class="download-btn">Скачать</button>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <p class="no-images">Вы еще не сохраняли изображений</p>
                            {% endfor %}
                        </div>

                        {% if images %}
                        <div class="view-all-container">
                            <a href="/my_images" class="view-all-link">Показать все изображения</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    // Обработчики для кнопок редактирования
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const infoItem = this.closest('.info-item');
            const infoLabel = infoItem.querySelector('.info-label').textContent;
            const infoValue = infoItem.querySelector('.info-value');

            // Пропускаем поля, которые нельзя редактировать (дата регистрации)
            if (infoLabel === 'Дата регистрации') return;

            // Сохраняем оригинальное значение
            const originalValue = infoValue.textContent;

            // Делаем поле редактируемым
            infoValue.contentEditable = true;
            infoValue.focus();

            // Добавляем класс для стилизации
            infoValue.classList.add('editing');

            // Скрываем кнопку редактирования
            this.style.display = 'none';

            // Создаем кнопки сохранения/отмены
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions';
            actionsDiv.innerHTML = `
                <button class="save-btn">✓</button>
                <button class="cancel-btn">✕</button>
            `;

            infoItem.appendChild(actionsDiv);

            // Обработчик сохранения
            actionsDiv.querySelector('.save-btn').addEventListener('click', async function() {
                const newValue = infoValue.textContent.trim();

                // Валидация
                if (infoLabel === 'Электронная почта' && !validateEmail(newValue)) {
                    alert('Пожалуйста, введите корректный email');
                    infoValue.focus();
                    return;
                }

                // Для даты приводим к формату DD.MM.YYYY
                let dbValue = newValue;
                if (infoLabel === 'Дата рождения') {
                    if (!isValidDate(newValue)) {
                        alert('Пожалуйста, введите дату в формате ДД.ММ.ГГГГ');
                        infoValue.focus();
                        return;
                    }
                    dbValue = formatDateForDB(newValue);
                }

                try {
                    // Отправка данных на сервер
                    const response = await updateUserInfo(infoLabel, dbValue);

                    if (response.success) {


                       if (response.user) {
                updateRelatedFields(infoLabel, newValue, response.user);
            }
                    } else {
                        // Восстанавливаем оригинальное значение при ошибке
                        infoValue.textContent = originalValue;
                        alert('Ошибка при обновлении: ' + response.message);
                    }
                } catch (error) {
                    infoValue.textContent = originalValue;
                    alert('Ошибка сети: ' + error.message);
                }

                // Восстанавливаем исходное состояние
                resetEditingState(infoItem, infoValue, btn);
            });

            // Обработчик отмены
            actionsDiv.querySelector('.cancel-btn').addEventListener('click', function() {
                infoValue.textContent = originalValue;
                resetEditingState(infoItem, infoValue, btn);
            });

            // Отмена при потере фокуса
            infoValue.addEventListener('blur', function() {
                setTimeout(() => {
                    if (!infoItem.contains(document.activeElement)) {
                        infoValue.textContent = originalValue;
                        resetEditingState(infoItem, infoValue, btn);
                    }
                }, 100);
            });
        });
    });

    // Функция валидации email
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Функция валидации даты
    function isValidDate(dateString) {
        const parts = dateString.split('.');
        if (parts.length !== 3) return false;

        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        if (isNaN(day) || isNaN(month) || isNaN(year)) return false;

        const date = new Date(year, month - 1, day);
        return date.getFullYear() === year &&
               date.getMonth() === month - 1 &&
               date.getDate() === day;
    }

    // Форматирование даты для БД (YYYY-MM-DD)
    function formatDateForDB(dateString) {
        const parts = dateString.split('.');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    // Обновление данных в сессии
    function updateSessionData(fieldName, displayValue, dbValue) {
        const fieldMap = {
            'Имя': 'first_name',
            'Фамилия': 'last_name',
            'Электронная почта': 'email',
            'Телефон': 'phone',
            'Дата рождения': 'birth_date'
        };

        const fieldKey = fieldMap[fieldName];
        if (fieldKey && session.user) {
            session.user[fieldKey] = dbValue;
        }
    }

    // Обновление связанных полей
  function updateRelatedFields(fieldName, newValue, userData) {
    if (!userData) return;

    // Обновляем полное имя в сайдбаре
    const fullName = `${userData.last_name || ''} ${userData.first_name || ''} ${userData.middle_name || ''}`.trim();
    document.querySelector('.user-name').textContent = fullName;

    // Обновляем отдельные поля в профиле
    const fieldSelectors = {
        'Имя': '.info-item .info-label:contains("Имя") + .info-value',
        'Фамилия': '.info-item .info-label:contains("Фамилия") + .info-value',
        'Электронная почта': '.info-item .info-label:contains("Электронная почта") + .info-value'
    };

    // Альтернативный вариант без :contains()
    const fieldSelectorsSafe = {
        'Имя': '.info-item:nth-child(1) .info-value', // Первый info-item - Имя
        'Фамилия': '.info-item:nth-child(2) .info-value', // Второй info-item - Фамилия
        'Электронная почта': '.info-item:nth-child(3) .info-value' // Третий - Email
    };

    if (fieldSelectorsSafe[fieldName]) {
        const element = document.querySelector(fieldSelectorsSafe[fieldName]);
        if (element) {
            element.textContent = newValue;
        }
    }

    // Обновляем email в сайдбаре
    if (fieldName === 'Электронная почта') {
        const emailElement = document.querySelector('.user-email');
        if (emailElement) {
            emailElement.textContent = userData.email;
        }
    }
}


    // Восстановление исходного состояния
    function resetEditingState(infoItem, infoValue, editBtn) {
        infoValue.contentEditable = false;
        infoValue.classList.remove('editing');

        const actionsDiv = infoItem.querySelector('.edit-actions');
        if (actionsDiv) {
            actionsDiv.remove();
        }

        editBtn.style.display = '';
    }

    // Функция обновления данных пользователя на сервере
    async function updateUserInfo(fieldName, newValue) {
        const fieldMap = {
            'Имя': 'first_name',
            'Фамилия': 'last_name',
            'Электронная почта': 'email',
            'Телефон': 'phone',
            'Дата рождения': 'birth_date'
        };

        const fieldKey = fieldMap[fieldName];
        if (!fieldKey) return { success: false, message: 'Неизвестное поле' };

        try {
            const response = await fetch('/update_profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    field: fieldKey,
                    value: newValue
                }),
                credentials: 'include'
            });

            return await response.json();
        } catch (error) {
            return { success: false, message: error.message };
        }
    }
</script>
    <script>
        // Обработчик для кнопки "На главную"
        document.querySelector('.nav-actions button').addEventListener('click', function() {
            window.location.href = '/';
        });

        // Обработчики для меню
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // Удаляем класс active у всех ссылок
                document.querySelectorAll('.nav-menu a').forEach(item => {
                    item.classList.remove('active');
                });

                // Добавляем класс active текущей ссылке
                this.classList.add('active');

                // Здесь можно добавить логику загрузки соответствующего раздела
                const sectionName = this.textContent.trim();

            });
        });


    </script>
<script>
    // Функция для просмотра изображения
    function viewImage(imageUrl) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        modal.innerHTML = `
            <div style="position:relative; max-width:90%; max-height:90%">
                <img src="${imageUrl}" style="max-width:100%; max-height:80vh; object-fit:contain;">
                <button style="position:absolute; top:-30px; right:0; background:none; border:none; color:white; font-size:24px; cursor:pointer;">×</button>
            </div>
        `;

        document.body.appendChild(modal);

        modal.querySelector('button').addEventListener('click', () => {
            modal.remove();
        });
    }

    // Функция для удаления изображения
           async function deleteImage(imageId) {
            if (!confirm('Вы уверены, что хотите удалить это изображение?')) return;

            try {
                const response = await fetch(`/delete_image/${imageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    const imageCard = document.querySelector(`.image-card[data-image-id="${imageId}"]`);
                    if (imageCard) {
                        imageCard.remove();

                        // Проверка оставшихся изображений
                        const imagesGrid = document.querySelector('.images-grid');
                        if (imagesGrid && imagesGrid.querySelectorAll('.image-card').length === 0) {
                            imagesGrid.innerHTML = '<p class="no-images">Вы еще не сохраняли изображений</p>';
                        }
                    }
                } else {
                    alert('Ошибка при удалении: ' + (result.message || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Ошибка сети: ' + error.message);
            }
        }

    // Функция для скачивания изображения
    function downloadImage(imageUrl, filename) {
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = filename || 'image.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Назначаем обработчики событий
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const imageUrl = this.closest('.image-card').querySelector('img').src;
            viewImage(imageUrl);
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const imageId = this.closest('.image-card').dataset.imageId;
            deleteImage(imageId);
        });
    });

    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const imgElement = this.closest('.image-card').querySelector('img');
            const imageUrl = imgElement.src;
            const filename = imageUrl.split('/').pop() || 'image.png';
            downloadImage(imageUrl, filename);
        });
    });
</script>
</body>
</html>